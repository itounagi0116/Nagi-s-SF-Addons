# VRChat 航空機向け総合天候システム仕様書

## 1. システム概要

航空機が飛行する環境において、リアルな天候表現を目的とした、「ボリューメトリック雲」「フォグ」「雨・雪・雹」「台風」「雷雨」「ゴッドレイ」「乱気流」を統合した天候制御システム。

VRChat上のPC向けワールドを想定。
天候はリアルタイムに切替可能とし、**コックピット内の視界確保（キャノピー対応）**も行う。

## 2. 機能要件

### 2.1. 雲システム

- **ボリューメトリック風雲表現**
  - 雲の高さ、厚み、密度、流速を設定可能
  - ノイズテクスチャベースの疑似3D表現
  - 遠距離ではフェードアウトして空に馴染む

- **昼夜対応**
  - Directional Lightの角度により、雲の色・明るさを昼夜で自動補正
  - 夜間は青黒いトーン、昼間は白〜灰色

- **キャノピー内非描画 (Stencilバッファ)**
  - コックピット内には雲を描画しない
  - キャノピー越しに外の雲が見える仕様

- **PBRライティング**
  - 散乱光（スキャッタリング）の物理ベース計算
  - 雲内部の光の減衰をより自然に表現
  - 太陽光の入射角度による色変化（日の出/日没時の赤み）
  - 雲の層による多重散乱効果
  - 3Dノイズテクスチャを用いた密度マップ
  - レイマーチングによる光の透過計算
  - 高度による雲の種類（巻雲・積雲・層雲）の自動分類

### 2.2. フォグシステム

- 雲シェーダーの技術を流用した地表〜低空域のフォグ
- 雲との自然なグラデーション接続
- 雲同様に昼夜補正、密度/厚み設定可
- キャノピー内は非描画

### 2.3. 降水・降雪システム

- **雨（Rain）**
  - 遠景に雨粒パーティクル
  - キャノピーに「水滴+流れ表現（レインシェーダー）」

- **雪（Snow）**
  - 舞い落ちる雪粒パーティクル
  - キャノピーが曇る/凍結するシェーダー

- **雹（Hail）**
  - 雪より大きく、早く落ちる粒子エフェクト
  - 雹がキャノピーに着弾するノーマルマップ/バンプ演出

### 2.4. 台風システム

- 強風による高速流れ模様の雲
- 雲が「渦巻き状」になる
- 風速・ノイズ流速の自動強化
- 雷雨と併用可能（嵐+雷雨）

### 2.5. 雷雨システム

- **雷光（フラッシュ）**
  - 雲内部が一瞬白く発光
  - ランダムタイミングで発光し、夜間にも対応

- **稲妻（ボルト）**
  - ビルボード型 or メッシュ型稲妻エフェクト
  - 稲妻ごとに個別に雷フラッシュとの同期

- **雷雨時の雲**
  - 重く暗い色に変化（ダークグレー）
  - 雷が発生するたびに雲が明るく光る

- **雷音サウンドシステム**
  - 距離に応じた雷音の遅延計算（光速と音速の差を考慮）
  - 複数パターンの雷音サンプル（近距離/中距離/遠距離）
  - 立体音響（3Dオーディオ）による方向感の表現
  - 機内/機外で異なる音響フィルター適用
  - 視覚的な稲妻発生と音響効果の正確なタイミング調整
  - 距離に基づく音量と低音の自動調整
  - 雷の規模に応じた音量/音質の変化

### 2.6. ゴッドレイ（体積光）システム

- ポストプロセスエフェクトとして実装
- Directional Lightの方向と雲の隙間を分析し、光筋を生成
- 雲の厚みデータを利用した半透明ボリューム表現
- 日の出/日没時に強調表示（朝夕の太陽光が横から差し込む時）
- 雲の厚みに応じた透過率の自動調整
- パフォーマンス設定に応じた品質調整（低負荷モードあり）

### 2.7. 乱気流システム

- **物理挙動**
  - 天候条件に連動した乱気流強度の動的変化
  - 3Dノイズマップを用いた空間的な乱気流分布
  - 高度・速度による影響度の調整

- **視覚/聴覚効果**
  - カメラの揺れ（ランダムな回転/移動）
  - 機体パーツの微振動表現（翼・エンジン）
  - 風切り音の強弱変化
  - コックピット内の計器/小物の揺れ

- **操縦への影響**（オプション）
  - 機体制御への外乱としての影響
  - 揺れによる視界の一時的ブレ
  - 高度計/速度計の微小変動

## 3. コントロール仕様

### 3.1. 天候パターン

- Clear（快晴）
- Fog（霧）
- Rain（雨）
- Snow（雪）
- Hail（雹）
- Thunderstorm（雷雨）
- Typhoon（台風）
- Typhoon+Thunderstorm（台風+雷雨）

### 3.2. コントロール方法

- UdonGraphまたはスクリプトから**WeatherType（Enum）**で切替
- VRChat内のUIパネル（ボタン）からも切替可能に設計
- 各効果の強度調整スライダー（オプション）
- 時間経過による天候の緩やかな変化設定

### 3.3. 統合制御システム

- 天候タイプに応じた各効果の自動設定（プリセット機能）
- 時間経過による天候の緩やかな変化
- 高度による影響度の自動調整
- パフォーマンス監視による自動品質調整

## 4. シェーダー構成

| シェーダー名 | 内容 |
|------------|------|
| VolumetricClouds.shader | 雲・フォグの共通シェーダー |
| RainOverlay.shader | キャノピー用 雨しずく流れシェーダー |
| CanopySnow.shader | キャノピー用 凍結/曇りシェーダー |
| LightningEffect.shader | 稲妻の発光ビルボード用シェーダー |
| GodRays.shader | 体積光表現用ポストプロセスシェーダー |
| CloudLighting.shader | 雲のPBRライティング用シェーダー |

## 5. サウンドシステム

### 5.1. 環境音響

- 雨音（強度に応じた音量変化）
- 風音（風速に応じた音質/音量変化）
- 雷音（距離/規模による変化）
- 雹の衝突音

### 5.2. 乱気流音響

- 乱気流時の機体振動音
- 風切り音の変動
- 機内の小物/装備の振動音

### 5.3. 音響制御

- 天候タイプによる自動音響設定
- 機内/機外での音響フィルター切替
- 3Dオーディオによる方向感と距離減衰

## 6. 実装メモ

- VRChat用PC向けパフォーマンスに最適化
- すべてのパーティクル・シェーダーはStencil対応済み（コックピット内部には入らない）
- 夜間時の視認性、昼間の白飛び防止を考慮したカラーバランス
- 視点からの距離に応じた詳細度調整
- GPU負荷監視による自動品質調整
- オプション機能のオン/オフ切り替え

## 7. 実装優先順位と段階的アプローチ

### 7.1. 第1段階：基本システム
1. 雲・フォグシステム（ボリューメトリック表現）
2. 天候コントローラー（基本的な切り替え機能）
3. キャノピー用基本シェーダー

### 7.2. 第2段階：視覚エフェクト拡張
1. 雨+雷エフェクト（視覚表現）
2. ゴッドレイ（体積光）実装
3. 雲のPBRライティング強化

### 7.3. 第3段階：聴覚・物理効果
1. 雷音サウンドシステム
2. 乱気流による機体の揺れ
3. 環境音響効果（雨音、風音など）

### 7.4. 第4段階：高度な連携と最適化
1. 各システムの連動性強化
2. パフォーマンス最適化
3. ユーザーインターフェース改良

## 8. 技術的な実装詳細

### 8.1. レンダリングパイプライン

- Unity Standard Render Pipeline対応
- レイマーチングベースのボリューメトリック表現
- マルチパスレンダリングによるレイヤー合成
- キャノピー内部のStencil排除処理

### 8.2. パフォーマンス最適化

- LOD（Level of Detail）による遠距離簡略化
- パーティクル数の動的調整
- シェーダー複雑度の切替オプション
- オクルージョンカリングによる非表示部分の処理省略

### 8.3. VRChat固有の対応

- Udonでの制御インターフェース
- マルチユーザー間での天候同期
- VRChatのパフォーマンスランクに配慮した設計
- アバターとの干渉への対応（オプション）
